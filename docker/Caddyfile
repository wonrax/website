(request-logging) {
	log {
		output stdout
		format filter {
			request>headers>Cookie delete
			wrap json {
				time_format iso8601
			}
		}
	}
}

hhai.dev {
	import request-logging

	handle_path /api/* {
		reverse_proxy api:3000 {
			# Trust all incoming X-Forwarded-For headers since we're behind
			# Cloudflare
			trusted_proxies 0.0.0.0/0
		}
	}

	handle {
		root * /www/hhai.dev
		try_files {path}.html

		file_server {
			disable_canonical_uris
			precompressed zstd gzip
		}

		route {
			header /_astro/* Cache-Control "max-age=31536000, immutable"
		}
	}

	encode zstd gzip
}

static.hhai.dev {
	import request-logging

	handle_path /hhai.dev/* {
		root * /www/hhai.dev
		try_files {path}.html
		file_server {
			disable_canonical_uris
			precompressed zstd gzip
		}

		route {
			header Cache-Control max-age=300
			header /_astro/* Cache-Control max-age=31536000
		}
	}

	encode zstd gzip
}

api.hhai.dev {
	import request-logging

	handle_path /api/* {
		reverse_proxy api:3000 {
			# Trust all incoming X-Forwarded-For headers since we verify the
			# proxy in application layer anyway
			trusted_proxies 0.0.0.0/0
		}
	}

	encode zstd gzip
}

files.hhai.dev {
	import request-logging

	root * /www/files.hhai.dev
	file_server {
		browse
	}
	header Access-Control-Allow-Origin "*"

	encode zstd gzip
}
