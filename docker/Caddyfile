# This is ineffective because the host machine is not directly accessible
# through this domain. Instead, a CloudFront distribution is used to serve
# the static files at static.hhai.dev.
# hhai.dev {
# 	handle_path /api/* {
# 		reverse_proxy api:3000
# 	}

# 	handle {
# 		root * /www/hhai.dev
# 		try_files {path}.html

# 		file_server {
#			disable_canonical_uris
# 			precompressed zstd gzip
# 		}

# 		route {
# 			header Cache-Control max-age=300
# 			header /_astro/* Cache-Control max-age=31536000
# 		}
# 	}

# 	encode zstd gzip
# }

static.hhai.dev {
	handle_path /hhai.dev/* {
		root * /www/hhai.dev
		try_files {path}.html
		file_server {
			disable_canonical_uris
			precompressed zstd gzip
		}

		route {
			header Cache-Control max-age=300
			header /_astro/* Cache-Control max-age=31536000
		}
	}

	encode zstd gzip
}

api.hhai.dev {
	handle_path /api/* {
		reverse_proxy api:3000 {
			# CloudFront proxy is trusted
			header_up X-Forwarded-For {http.request.header.X-Forwarded-For}
		}
	}

	encode zstd gzip
}

next.hhai.dev {
	root * /www/next-www
	try_files {path}.html
	file_server
}

share.hhai.dev {
	root * /www/share.hhai.dev
	file_server {
		browse
	}
	header Access-Control-Allow-Origin "*"

	encode zstd gzip
}

windmill.hhai.dev {
    reverse_proxy /ws/* http://windmill_lsp:3001
    reverse_proxy /* http://windmill_server:8000
}
